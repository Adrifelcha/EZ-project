---
title: "EZ Bayesian Hierarchical Drift Diffusion Model"
subtitle: "Short report"
author: "Adriana F. Chávez De la Peña"
date: "`r Sys.Date()`"
output:
  rmdformats::material:
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: true
    cards: false
    highlight: tango
    fig_width: 12 
    fig_height: 8 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
library(rmdformats)
```

# Introduction

\begin{align*}
\mathbf{Y} \sim \mbox{DDM}\bigl(\alpha, \nu, \tau \bigl)
\end{align*}

## The EZBHDDM

\begin{align*}
Y &\Rightarrow \{\dot{T}, \dot{M}, \dot{V}\}\\
\dot{T} &\sim \mbox{Binomial}(PC,N)\\
\dot{V} &\sim \mbox{Normal}(\frac{1}{PRT},\frac{N-1}{2(PRT)^2})\\
\dot{M} &\sim \mbox{Normal}(MRT, PRT \times N)\\
PC &= \frac{1}{\exp(-\alpha\nu)+1}\\
MRT &= \tau + \frac{\alpha}{2\nu}\frac{\exp(-\alpha\nu)-1}{\exp(-\alpha\nu)+1}\\
PRT &= \frac{\alpha}{2\nu^3}\{\frac{1-2\alpha\nu\exp(-\alpha\nu)-\exp(-\alpha\nu)^2}{(\exp(-\alpha\nu)+1)^2}\}
\end{align*}

# Main functions

## Simulation setup functions

```{r, echo=FALSE}
source("./code/functions/namingFunctions.R")
source("./code/functions/show_priors.R")
source("./code/functions/show_parameters.R")
source("./code/functions/show_design.R")
source("./code/functions/default_priors.R")
source("./code/functions/sample_parameters.R")
```

1. `default_priors()`: A function to load default prior values.
2. `sample_parameters()`: A function to sample true parameter values from the priors specified.

## Functions to interact with JAGS

```{r, echo=FALSE}
source("./code/functions/write_JAGSmodel.R")
source("./code/functions/data_toJAGS.R")
source("./code/functions/default_inits.R")
source("./code/functions/extractSamples.R")
source("./code/functions/getDifferences_TRUEvsEST.R")
source("./code/functions/check_Rhat.R")
source("./code/functions/plot_Chain.R")
```

1. `write_JAGSmodel()`: A function to write the JAGS model using the prior values.
2. `data_toJAGS()`: A function to create a list with all the data objects to be passed to JAGS.
3. `default_inits()`:  A function to create an object containing initial values for the drift.
4. `extractSamples()`: A function to extract all samples associated with a `parameter.name`
5. `getDifferences_TRUEvsEST()`: A function to compute the difference between the true value and estimate retrieved for every parameter.
6. `check_Rhat()`: A function to check the Rhats for a simulation
7. `plot_Chain()`: A function to plot the merging chains for hierarchical parameters


## Data managment functions

1. `generate_trial()`:
2. `generate_dataset()`:

```{r, echo=FALSE}
source("./code/functions/generate_trial.R")
source("./code/functions/generate_dataset.R")
source("./code/functions/sample_data.R")
source("./code/functions/getStatistics.R")
```

```{r example-parameters}
data <- generate_dataset(a=1.5, v=0, t=0.3, n=1000)
```

```{r example-plot, echo=FALSE, fig.height=5}
par(mfrow = c(1, 3), mar =c(5.1,2,4.1,2), bty = "o")

rt <- data$RT
accuracy <- data$accuracy

hist(rt[accuracy==1], ann=F, axes=F, breaks=50, col="lightgreen", border=NA)
mtext("Distribution of Reaction Times", 3, cex=0.65, line=0.5)
mtext("Reaction Time", 1, cex=0.6, line=2)
mtext("Count", 2, cex=0.6, line=1)
legend("topright", col="lightgreen", "Correct", pch=15, cex=0.7, bty="n")
axis(1,c(0:5),line=-0.7)

hist(rt[accuracy==0], ann=F, axes=F, breaks=50, col="indianred1", border=NA)
mtext("Distribution of Reaction Times", 3, cex=0.65, line=0.5)
mtext("Reaction Time", 1, cex=0.6, line=2)
mtext("Count", 2, cex=0.6, line=1)
legend("topright", col="indianred1", "Incorrect", pch=15, cex=0.7, bty="n")
axis(1,c(0:5),line=-0.7)

barplot(c(sum(1-accuracy),sum(accuracy)), ann=F, axes=F, col=c("red3","springgreen3"))
mtext("Accuracy Histogram", 3, cex=0.65, line=0.5)
mtext("Count", 2, cex=0.6, line=1)
axis(1,c(0.7,1.9),c("Incorrect","Correct"))
```

3. `sample_data()`:
4. `getStatistics()`:

## Plotting functions

```{r, echo=FALSE}
source("./code/functions/plot_recovery.R")
```

1. `plot_recovery()`:

# Scripts

1. `Hddm_setup`: 

```{r, echo=FALSE}
source("./code/scripts/HDDM_setup.R")
```

```{r, file="./code/scripts/HDDM_setup.R"}
```

2. `HDDM_runJAGS`: 

```{r, echo=FALSE}
source("./code/scripts/HDDM_runJAGS.R")
```

```{r, file="./code/scripts/HDDM_runJAGS.R"}
```

3. `HDDM_runSims`:

```{r, echo=FALSE}
source("./code/scripts/HDDM_runSims.R")
```


```{r, file="./code/scripts/HDDM_runSims.R"}
```



\begin{align*}
\mathbf{Y}_{ik} &\sim \mbox{DDM}(\nu_i, \alpha_{i}, \tau_{i}) \\
\nu_i &\sim \mbox{N}(\mu_\nu, \sigma_\nu)\\
\alpha_i &\sim \mbox{N}(\mu_\alpha, \sigma_\alpha)\\
\tau_i &\sim \mbox{N}(\mu_\tau, \sigma_\tau)
\end{align*}

```{r}
cat(readLines('./EZHBDDM.bug'), sep = '\n')
```

# Run simple example

```{r}
sim <- HDDM_runSims(nParticipants = 100, nTrials = 200, nDatasets = 1)
```

```{r, echo=FALSE, fig.height=4, fig.align='center'}
plot_recovery(sim)
```


# Full smulation studies (200 repetitions)

\vspace{.75in}

## 150 trials

```{r}
nDatasets <- 200

nT <- 150
nP1 <- 10
nP2 <- 80
nP3 <- 200
```

```{r, results='hide',message=FALSE, eval=FALSE}
simStudy1 <- HDDM_runSims(nParticipants = nP1, nTrials = nT, nDatasets = nDatasets, Show=TRUE)
simStudy2 <- HDDM_runSims(nParticipants = nP2, nTrials = nT, nDatasets = nDatasets, Show=TRUE)
simStudy3 <- HDDM_runSims(nParticipants = nP3, nTrials = nT, nDatasets = nDatasets, Show=TRUE)
```

```{r}
plot_recovery(simStudy1)
plot_recovery(simStudy2)
plot_recovery(simStudy3)
```

## 150 participants

```{r}
nDatasets <- 200

nP <- 150
nT1 <- 10
nT2 <- 80
nT3 <- 200
nT4 <- 500
```

```{r, results='hide',message=FALSE, eval=FALSE}
simStudy5 <- HDDM_runSims(nParticipants = nP, nTrials = nT1, nDatasets = nSim, Show=TRUE)
simStudy6 <- HDDM_runSims(nParticipants = nP, nTrials = nT2, nDatasets = nSim, Show=TRUE)
simStudy7 <- HDDM_runSims(nParticipants = nP, nTrials = nT3, nDatasets = nSim, Show=TRUE)
simStudy8 <- HDDM_runSims(nParticipants = nP, nTrials = nT4, nDatasets = nSim, Show=TRUE)
```


```{r}
nDatasets <- 200
  
level1 <- 20 
level2 <- 40
level3 <- 80
level4 <- 160
level5 <- 320
```

```{r, eval=FALSE}
ss11 <- HDDM_runSims(nParticipants = level1, nTrials = level1, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss12 <- HDDM_runSims(nParticipants = level1, nTrials = level2, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss13 <- HDDM_runSims(nParticipants = level1, nTrials = level3, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss14 <- HDDM_runSims(nParticipants = level1, nTrials = level4, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss15 <- HDDM_runSims(nParticipants = level1, nTrials = level5, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)

ss21 <- HDDM_runSims(nParticipants = level2, nTrials = level1, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss22 <- HDDM_runSims(nParticipants = level2, nTrials = level2, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss23 <- HDDM_runSims(nParticipants = level2, nTrials = level3, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss24 <- HDDM_runSims(nParticipants = level2, nTrials = level4, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss25 <- HDDM_runSims(nParticipants = level2, nTrials = level5, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)

ss31 <- HDDM_runSims(nParticipants = level3, nTrials = level1, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss32 <- HDDM_runSims(nParticipants = level3, nTrials = level2, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss33 <- HDDM_runSims(nParticipants = level3, nTrials = level3, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss34 <- HDDM_runSims(nParticipants = level3, nTrials = level4, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss35 <- HDDM_runSims(nParticipants = level3, nTrials = level5, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)

ss41 <- HDDM_runSims(nParticipants = level4, nTrials = level1, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss42 <- HDDM_runSims(nParticipants = level4, nTrials = level2, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss43 <- HDDM_runSims(nParticipants = level4, nTrials = level3, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss44 <- HDDM_runSims(nParticipants = level4, nTrials = level4, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss45 <- HDDM_runSims(nParticipants = level4, nTrials = level5, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)

ss51 <- HDDM_runSims(nParticipants = level5, nTrials = level1, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss52 <- HDDM_runSims(nParticipants = level5, nTrials = level2, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss53 <- HDDM_runSims(nParticipants = level5, nTrials = level3, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss54 <- HDDM_runSims(nParticipants = level5, nTrials = level4, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
ss55 <- HDDM_runSims(nParticipants = level5, nTrials = level5, nDatasets = nDatasets, Show=TRUE, forceSim = TRUE)
```

```{r, message=FALSE, results='hide', echo=FALSE, fig.align='center'}
plot_recovery(ss11)
plot_recovery(ss12)
plot_recovery(ss13)
plot_recovery(ss14)
plot_recovery(ss15)
```

# Meta Regression

-------------------

\begin{align*}
\mathbf{Y}_{ik} &\sim \mbox{DDM}(\delta_{i}, \eta_i, \tau_{i}) \\
\textcolor{red}{\delta_i &\sim \mbox{N}(\beta_0 + \beta_1x_i, \sigma_\delta)\\}
\eta_i &\sim \mbox{N}(\mu_\eta, \sigma_\eta)\\
\tau_i &\sim \mbox{N}(\mu_\tau, \sigma_\tau)
\end{align*}

# Function tunning

The code for the auxiliary functions listed below is hidden from this pdf file (but can be checked on the .Rmd). 

1. `getCovariates`: A function to obtain a list of random covariates (i.e. real numbers vs indicator variables)
2. `default_priors2`: A function to load and print default prior values. 
3. `sample_parameters`: A function to sample true parameter values from the priors specified. 
4. `write_JAGSmodel`: A function to write the JAGS model using the prior values.
5. `data_toJAGS`: A function to create a list with all the data objects to be passed to JAGS.
6. `default_inits`:  A function to create an object containing initial values for the drift.
7. `extractSamples`: A function to extract all samples associated with a `parameter.name`
8. `plot.Chain`: A function to plot the merging chains for hierarchical parameters
9. `getError`: A function to compute the difference between the true value and estimate retrieved for every parameter.
10. `nameOutput` : A function to generate an appropriate output name based on the number of trials and participants


```{r, echo=FALSE}
# A function to obtain a list of random covariates (i.e., real numbers or indicator variables)
getCovariates<- function(n, mean, sd, n.indexes=NA){
    if(is.na(n.indexes)){   # Covariate is a real number
          x <- rnorm(n,mean, sd)
    }else{     # Covariate is an indicative variable
          if(n.indexes==2){
                x <- rbinom(n,1,0.5)
          }else{
                p <- rep(1/n.indexes,n.indexes) 
                y <- rmultinom(n,1,p)
                x <- rep(0,n)
                for(i in 1:n.indexes){
                    x[y[i,]==1] <- i
                }
          }
    }
  return(x)
}
 
# A function to load and print default prior values
default_priors2 <- function(Show=TRUE){
     prior <- default_priors(Show=FALSE)   # Load regular priors
     prior$drift_mean_mean <- NULL       # Remove drift hierarchical distribution
     prior$drift_mean_sdev <- NULL
     prior$drift_intercept_mean <- 1.50  # Add a prior for the intercept and coefficients
     prior$drift_intercept_sdev <- 0.20
     prior$drift_coefficient_mean <- 0.00
     prior$drift_coefficient_sdev <- 0.50
     if(Show){
           show_priors(prior)
     }
   return(prior)
}

# A function to sample true parameter values from the priors specified
sample_parameters2 <- function(x, settings, parameter_set, Show=TRUE){
    prior <- settings$prior
    drift_B0 <- rnorm(1,prior$drift_intercept_mean,prior$drift_intercept_sdev)
    drift_B1 <- rnorm(1,prior$drift_coefficient_mean,prior$drift_coefficient_sdev)
    drift_mean <- drift_B0+(drift_B1*x)
    parameter_set$drift_intercept <- drift_B0
    parameter_set$drift_coefficient <- drift_B1
    parameter_set$drift_mean <- drift_mean
    parameter_set$drift <- rnorm(settings$nPart,drift_mean, drift_sdev)
    if(Show){     show_parameters(parameter_set)      }
  return(parameter_set)
}


# A function to create a list with all the data objects in the JAGS model
data_toJAGS <- function(){
    passData <- list("nParticipants", "nTrialsPerPerson",
                     "meanRT", "varRT", "correct")
    return(passData)
}

default_inits <- function(n.chains,nParticipants){
  myinits <- rep(list(list()), n.chains)
  for(i in 1:n.chains){
      myinits[[i]] <- list(drift = rnorm(nParticipants,0,0.1))
  }
  return(myinits)
}
```

